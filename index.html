<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>MapLibre Demotile - OMT</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='maplibre/maplibre-gl.js'></script>
    <script src="maplibre/turf.js"></script>
    <link href='maplibre/maplibre-gl.css' rel='stylesheet' />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #menu {
            position: absolute;
            top: 90px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1;

            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 3px;
            justify-content: space-between;
        }

        .item:hover {
            background: #f0f0f0;
        }

        #menu input {
            margin-right: 5px;
        }

        #circle-selection {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1;
        }

        #bottom-info {
            position: absolute;
            bottom: 30px;
            background: white;
            border-radius: 5px;
            z-index: 1;
            left: 50%;
            transform: translate(-50%, 0px);
            display: none;
        }

        #bottom-info-text {
            padding: 10px;
        }

        #close-info {
            position: absolute;
            top: 0;
            right: 0;
            cursor: pointer;
            padding: 5px;
            z-index: 2;
            height: 10px;
            width: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>

    <div id="map">
        <div id="circle-selection"></div>
        <div id="menu"></div>
        <div id="bottom-info">
            <div id="close-info">
                <svg xmlns="http://www.w3.org/2000/svg" width="5" height="5" viewBox="0 0 50 50" overflow="visible"
                    stroke="black" stroke-width="10" stroke-linecap="round">
                    <line x2="50" y2="50" />
                    <line x1="50" y2="50" />
                </svg>
            </div>
            <div id="bottom-info-text"></div>
        </div>
    </div>

    <script>

        const appData = {
            markers: [],
            circle: {
                radius: 1,
                lng: 96.10329999999992,
                lat: 19.63702750032419
            }
        }
        const tileUrl = 'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const apiUrl = `data.json`
        const menu = document.getElementById('menu');
        const circleSelectionDiv = document.getElementById('circle-selection');
        const bottomInfo = document.getElementById('bottom-info');
        const bottomInfoText = document.getElementById('bottom-info-text');
        const closeInfo = document.getElementById('close-info');

        const svgVoice = ``

        const style = {
            "version": 8,
            "sources": {
                "osm": {
                    "type": "raster",
                    "tiles": [tileUrl],
                    "tileSize": 256,
                    "attribution": "&copy; OpenStreetMap Contributors",
                    "maxzoom": 19
                }
            },
            "glyphs": `/mapfonts/{fontstack}/{range}.pbf`,
            "layers": [
                {
                    "id": "osm",
                    "type": "raster",
                    "source": "osm" // This must match the source key above
                }
            ]
        };

        // Initialise the map
        const map = new maplibregl.Map({
            container: 'map',
            style: style,
            center: { lng: 96.01259488396033, lat: 19.531402305502922 },
            zoom: 0
        });

        // Add the navigation control
        map.addControl(new maplibregl.NavigationControl());

        const canvas = map.getCanvasContainer();

        const geojson = {
            'type': 'FeatureCollection',
            'features': [
                {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [appData.circle.lng, appData.circle.lat]
                    }
                }
            ]
        };


        map.on('load', () => {

            map.addSource('points', {
                type: 'geojson',
                data: {
                    "type": "FeatureCollection",
                    "features": []
                },
                cluster: true,
                clusterMaxZoom: 20, // Max zoom to cluster points on
                clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
            });
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'points',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': '#51bbd6',
                    'circle-radius': 20
                }
            });
            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'points',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',

                    'text-size': 12
                }
            });
            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'points',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#11b4da',
                    'circle-radius': 5,
                    'circle-stroke-width': 1,
                    'circle-color': '#007cbf'
                }
            });


            //SELCT circle
            map.addSource('point', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [appData.circle.lng, appData.circle.lat]
                    }
                }
            });
            map.addSource('circle', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Polygon',
                        'coordinates': []
                    }
                }
            });
            map.addLayer({
                'id': 'select-circle-center',
                'type': 'circle',
                'source': 'point',
                'visibility': 'visible',
                'paint': {
                    'circle-radius': 10,
                    'circle-color': '#F84C4C' // red color
                }
            });
            map.addLayer({
                'id': 'select-circle',
                'type': 'fill',
                'source': 'circle',
                'visibility': 'visible',
                'layout': {},
                'paint': {
                    'fill-color': '#F84C4C',
                    'fill-opacity': 0.5
                }
            });



            // When the cursor enters a feature in
            // the point layer, prepare for dragging.
            map.on('mouseenter', 'select-circle-center', () => {
                map.setPaintProperty('select-circle-center', 'circle-color', '#3bb2d0');
                canvas.style.cursor = 'move';
            });
            map.on('mouseleave', 'select-circle-center', () => {
                map.setPaintProperty('select-circle-center', 'circle-color', '#3887be');
                canvas.style.cursor = '';
            });
            map.on('mousedown', 'select-circle-center', (e) => {
                // Prevent the default map drag behavior.
                e.preventDefault();
                canvas.style.cursor = 'grab';
                map.on('mousemove', onMove);
                map.once('mouseup', onUp);
            });
            map.on('touchstart', 'select-circle-center', (e) => {
                if (e.points.length !== 1) return;
                // Prevent the default map drag behavior.
                e.preventDefault();
                map.on('touchmove', onMove);
                map.once('touchend', onUp);
            });


            map.on('click', 'clusters', (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                const clusterId = features[0].properties.cluster_id;
                map.getSource('points').getClusterExpansionZoom(clusterId, (err, zoom) => {
                    if (err) return;

                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                });
            });
            map.on('mouseenter', 'clusters', (e) => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'clusters', (e) => {
                map.getCanvas().style.cursor = '';
            });


            map.on('mouseenter', 'unclustered-point', (e) => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'unclustered-point', (e) => {
                map.getCanvas().style.cursor = '';
            });
            map.on('click', 'unclustered-point', (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const description = e.features[0].properties.title;
                new maplibregl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);

                showBottomInfo({ text: description });
            });


            loadData();
            updateCircle({ lat, lng });
        })

        closeInfo.addEventListener('click', () => {
            showBottomInfo({ text: '' });
        });

        function showBottomInfo({ text }) {
            if (text === '') {
                bottomInfo.style.display = 'none';
            }
            else {
                bottomInfo.style.display = 'block';
                bottomInfoText.innerHTML = text;
            }
        }



        function onMove(e) {
            const { lng, lat } = e.lngLat;
            updateCircle({ lat, lng });
        }

        function onUp(e) {
            const coords = e.lngLat;
            canvas.style.cursor = '';
            // Unbind mouse/touch events
            map.off('mousemove', onMove);
            map.off('touchmove', onMove);
        }

        const updateCircle = ({ lat, lng }) => {
            canvas.style.cursor = 'grabbing';
            geojson.features[0].geometry.coordinates = [lng, lat];
            appData.circle.lng = lng;
            appData.circle.lat = lat;
            const circle = turf.circle([lng, lat], appData.circle.radius, {
                steps: 50,
                units: 'kilometers'
            });
            map.getSource('point').setData(geojson);
            map.getSource('circle').setData(circle);
        }


        const loadData = () => {

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log(data)

                    const bounds = new maplibregl.LngLatBounds();
                    const pins = data.map((item, id) => {
                        const [lat, lon] = item.latlon.split(',').map(parseFloat);
                        bounds.extend([lon, lat]);

                        appData.markers.push({
                            id: item.id,
                            lat,
                            lon,
                            time: item.time,
                            title: item.title,
                            iriType: item.iriType
                        });

                        return {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [lon, lat]
                            },
                            "properties": {
                                "id": item.id,
                                "time": item.time,
                                "title": item.title,
                                "iriType": item.iriType,
                            }
                        }
                    })
                    const geojson = {
                        "type": "FeatureCollection",
                        "features": pins
                    };
                    map.getSource('points').setData(geojson);
                    map.fitBounds(bounds, {
                        padding: 100,
                    });
                    // Calculate center from bounds
                    // const { _ne, _sw } = bounds;
                    // const ne = _ne.toArray(); // North-east coordinates [lng, lat]
                    // const sw = _sw.toArray(); // South-west coordinates [lng, lat]
                    // const centerLng = (ne[0] + sw[0]) / 2;
                    // const centerLat = (ne[1] + sw[1]) / 2;
                    // const center = new maplibregl.LngLat(centerLng, centerLat);
                    // map.panTo(center, { zoom: 17 });

                    renderItemsMenu(appData.markers);
                    createCircle();
                })
        }

        const createCircle = () => {
            const circle = document.createElement('div');
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.checked = true;
            input.addEventListener('change', (e) => {
                const visibility = input.checked ? 'visible' : 'none';
                map.setLayoutProperty('select-circle', 'visibility', visibility);
                map.setLayoutProperty('select-circle-center', 'visibility', visibility);
            });
            const label = document.createElement('label');
            label.textContent = 'Circle Selection';
            label.style.cursor = 'pointer';
            label.htmlFor = 'circle-selection';

            const radiusSliderDiv = document.createElement('div');
            const radiusSlider = document.createElement('input');
            radiusSlider.type = 'range';
            radiusSlider.min = 0;
            radiusSlider.max = 100;
            radiusSlider.value = 1;
            radiusSlider.addEventListener('input', (e) => {
                appData.circle.radius = parseInt(e.target.value);
                updateCircle({ lat: appData.circle.lat, lng: appData.circle.lng });
            });
            radiusSliderDiv.appendChild(radiusSlider);

            circleSelectionDiv.appendChild(input);
            circleSelectionDiv.appendChild(label);
            circleSelectionDiv.appendChild(radiusSliderDiv);

        }
        const renderItemsMenu = (data) => {
            data.forEach((item) => {
                const itemElement = createItem(item);
                menu.appendChild(itemElement);
            })
        }

        const createItem = (data) => {

            const { lat, lon, time, iriType, title } = data;
            const item = document.createElement('div');
            item.className = 'item';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.checked = true;
            input.addEventListener('change', (e) => {
                const checked = e.target.checked;
                const layerId = data.id;
                if (checked) {
                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                } else {
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                }
            });

            const img = document.createElement('img');
            const imgType = iriType === 'voice'
                ? 'voice.svg' : iriType === 'report'
                    ? 'report.svg' : 'sms.svg';
            img.src = `/icons/${imgType}`;
            img.style.width = '20px';
            img.style.height = '20px';
            img.style.marginRight = '5px';

            const label = document.createElement('label');
            label.textContent = time;
            label.style.cursor = 'pointer';
            label.addEventListener('click', () => {
                map.flyTo({
                    center: [lon, lat],
                    zoom: 18
                });
            });

            item.appendChild(input);
            item.appendChild(label);
            item.appendChild(img);

            return item;
        }


    </script>


</body>

</html>